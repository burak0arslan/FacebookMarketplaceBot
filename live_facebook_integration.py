#!/usr/bin/env python3
"""
Live Facebook Integration - Real Account Setup
This script helps you safely connect to real Facebook accounts for live monitoring
"""

import sys
import os
import time
import getpass
from pathlib import Path
from typing import List, Dict, Any, Optional
from datetime import datetime

# Add project root to path
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

from models.account import Account
from services.facebook_bot import FacebookBot
from services.llama_ai import LlamaAI
from utils.browser_utils import create_browser_manager
from utils.logger import setup_logging, get_logger
from config import Config


class LiveFacebookIntegration:
    """
    Safely integrate with real Facebook accounts for live monitoring

    Features:
    - Secure account validation
    - Real Facebook login testing
    - Live message monitoring setup
    - Safety checks and recommendations
    - Account health monitoring
    """

    def __init__(self):
        """Initialize live integration manager"""
        setup_logging()
        self.logger = get_logger(__name__)

        # Test accounts
        self.test_accounts: List[Account] = []
        self.validated_accounts: List[Account] = []

        # System components
        self.ai_service = LlamaAI()

        # Safety settings
        self.safety_mode = True
        self.max_test_accounts = 2
        self.login_timeout = 60  # seconds

    def create_secure_test_account(self) -> Optional[Account]:
        """
        Safely create a test account with real credentials
        """
        print("\nüîê Setting Up Real Facebook Account")
        print("=" * 50)
        print("‚ö†Ô∏è  IMPORTANT SECURITY NOTES:")
        print("   ‚Ä¢ Only use accounts you own or have permission to use")
        print("   ‚Ä¢ Consider using secondary/business accounts for testing")
        print("   ‚Ä¢ Never share credentials or use someone else's account")
        print("   ‚Ä¢ Start with 1-2 accounts maximum for testing")
        print()

        try:
            # Get account information securely
            email = input("üìß Facebook Email: ").strip()
            if not email or '@' not in email:
                print("‚ùå Invalid email format")
                return None

            # Secure password input
            password = getpass.getpass("üîí Facebook Password: ").strip()
            if not password:
                print("‚ùå Password cannot be empty")
                return None

            profile_name = input("üë§ Profile Name (display name): ").strip()
            if not profile_name:
                profile_name = email.split('@')[0].title()

            # Create account object
            account = Account(
                email=email,
                password=password,
                profile_name=profile_name,
                active=True,
                message_monitor=True
            )

            print(f"‚úÖ Account created: {account.get_masked_email()}")
            return account

        except KeyboardInterrupt:
            print("\n‚èπÔ∏è Account setup cancelled")
            return None
        except Exception as e:
            print(f"‚ùå Error creating account: {e}")
            return None

    def test_facebook_login(self, account: Account) -> bool:
        """
        Test Facebook login with real account

        Args:
            account: Account to test

        Returns:
            True if login successful, False otherwise
        """
        try:
            print(f"\nüîê Testing login for {account.get_masked_email()}")
            print("‚è≥ This may take 30-60 seconds...")

            # Create browser in non-headless mode for login testing
            with create_browser_manager(headless=False) as browser:
                # Initialize Facebook bot
                bot = FacebookBot(account, headless=False)
                bot.browser = browser

                print("üåê Opening Facebook...")

                # Navigate to Facebook
                if not browser.navigate_to("https://www.facebook.com"):
                    print("‚ùå Could not navigate to Facebook")
                    return False

                time.sleep(3)

                # Attempt login via session start
                print("üîë Attempting login...")
                login_success = bot.start_session()

                if login_success:
                    print("‚úÖ Login successful!")

                    # Test navigation to key areas
                    print("üîç Testing navigation...")

                    # Test marketplace access
                    if bot.navigate_to_marketplace():
                        print("‚úÖ Marketplace access confirmed")
                    else:
                        print("‚ö†Ô∏è Marketplace access limited")

                    # Test messages access
                    if hasattr(bot, 'navigate_to_messages'):
                        if bot.navigate_to_messages():
                            print("‚úÖ Messages access confirmed")
                        else:
                            print("‚ö†Ô∏è Messages access limited")

                    # End session properly
                    bot.end_session()

                    print("üéâ Account validation successful!")
                    return True
                else:
                    print("‚ùå Login failed")
                    self._diagnose_login_failure(browser)
                    return False

        except Exception as e:
            print(f"‚ùå Login test error: {e}")
            return False

    def _diagnose_login_failure(self, browser):
        """Diagnose why login might have failed"""
        try:
            # Check for common login issues
            page_source = browser.driver.page_source.lower()

            if "captcha" in page_source:
                print("üîç Diagnosis: CAPTCHA detected")
                print("   üí° Solution: Complete CAPTCHA manually and try again")
            elif "checkpoint" in page_source or "security" in page_source:
                print("üîç Diagnosis: Security checkpoint detected")
                print("   üí° Solution: Complete security verification manually")
            elif "incorrect" in page_source or "wrong" in page_source:
                print("üîç Diagnosis: Incorrect credentials")
                print("   üí° Solution: Verify email and password are correct")
            elif "locked" in page_source or "disabled" in page_source:
                print("üîç Diagnosis: Account may be locked or disabled")
                print("   üí° Solution: Try logging in manually first")
            else:
                print("üîç Diagnosis: Unknown login issue")
                print("   üí° Solution: Try logging in manually first")

        except Exception as e:
            print(f"Could not diagnose login failure: {e}")

    def setup_live_monitoring_session(self, validated_accounts: List[Account]) -> bool:
        """
        Set up live monitoring session with real accounts

        Args:
            validated_accounts: List of validated Facebook accounts

        Returns:
            True if setup successful, False otherwise
        """
        try:
            print(f"\nüöÄ Setting Up Live Monitoring Session")
            print("=" * 50)
            print(f"üë• Accounts: {len(validated_accounts)}")

            # Test AI system
            if not self.ai_service.test_connection():
                print("‚ùå AI system not available - monitoring will be limited")
                return False

            print("‚úÖ AI system ready")

            # Initialize bots for live monitoring
            active_bots = {}

            for account in validated_accounts:
                try:
                    print(f"ü§ñ Setting up live bot for {account.get_masked_email()}")

                    # Create bot instance
                    bot = FacebookBot(account, headless=False)  # Non-headless for live monitoring
                    active_bots[account.email] = bot

                    print(f"‚úÖ Bot ready for {account.get_masked_email()}")

                except Exception as e:
                    print(f"‚ùå Error setting up bot for {account.get_masked_email()}: {e}")
                    continue

            if not active_bots:
                print("‚ùå No bots successfully set up")
                return False

            print(f"‚úÖ {len(active_bots)} bots ready for live monitoring")

            # Show monitoring configuration
            print(f"\n‚öôÔ∏è Live Monitoring Configuration:")
            print(f"   Check interval: {Config.MESSAGE_CHECK_INTERVAL} seconds")
            print(f"   Auto-reply: {'‚úÖ Enabled' if Config.AUTO_REPLY_ENABLED else '‚ùå Disabled'}")
            print(f"   Reply delay: {Config.REPLY_DELAY_MIN}-{Config.REPLY_DELAY_MAX} seconds")
            print(f"   AI model: {Config.LLAMA_MODEL_NAME}")

            return True

        except Exception as e:
            print(f"‚ùå Error setting up live monitoring: {e}")
            return False

    def run_live_monitoring_demo(self, duration_minutes: int = 5) -> bool:
        """
        Run a short live monitoring demonstration

        Args:
            duration_minutes: How long to run the demo

        Returns:
            True if successful, False otherwise
        """
        try:
            print(f"\nüé¨ Running Live Monitoring Demo ({duration_minutes} minutes)")
            print("=" * 60)
            print("‚ö†Ô∏è  DEMO MODE - SAFE TESTING:")
            print("   ‚Ä¢ Will monitor for real messages")
            print("   ‚Ä¢ Will generate AI responses")
            print("   ‚Ä¢ Will NOT send responses automatically")
            print("   ‚Ä¢ You can review and approve each response")
            print()

            input("Press Enter to start live demo...")

            # This would integrate with your existing monitoring system
            from phase4_message_monitoring import MessageMonitoringManager

            # Create monitoring manager in demo mode
            manager = MessageMonitoringManager()
            manager.auto_reply_enabled = False  # Disable auto-reply for demo

            # Load validated accounts
            manager.accounts = self.validated_accounts

            if not manager.test_ai_connection():
                print("‚ùå AI system not available")
                return False

            if not manager.initialize_bots():
                print("‚ùå Could not initialize bots")
                return False

            print("üöÄ Starting live demo monitoring...")

            # Run monitoring with manual approval
            def demo_message_processor(message):
                """Process messages with manual approval"""
                print(f"\nüì© NEW MESSAGE DETECTED:")
                print(f"   From: {message.sender_name}")
                print(f"   Content: {message.content}")
                print(f"   Product: {message.product_title or 'Unknown'}")

                if message.requires_human_attention:
                    print("‚ö†Ô∏è  Message requires human attention (escalated)")
                    return True

                # Generate AI response
                response = manager.generate_ai_response(message)

                if response:
                    print(f"\nü§ñ PROPOSED AI RESPONSE:")
                    print(f"   '{response}'")

                    # Ask for approval
                    choice = input("\n   Send this response? [y/N/edit]: ").strip().lower()

                    if choice == 'y':
                        print("‚úÖ Response approved - sending...")
                        # In real implementation, would send via manager.send_response()
                        print("üì§ Response sent successfully (simulated)")
                        return True
                    elif choice == 'edit':
                        custom_response = input("   Enter custom response: ").strip()
                        if custom_response:
                            print(f"‚úÖ Custom response: '{custom_response}'")
                            print("üì§ Custom response sent (simulated)")
                            return True
                    else:
                        print("‚è∏Ô∏è Response skipped")
                        return True
                else:
                    print("‚ùå Could not generate AI response")
                    return False

            # Run monitoring cycles
            import time
            from datetime import datetime, timedelta

            end_time = datetime.now() + timedelta(minutes=duration_minutes)
            cycle = 0

            while datetime.now() < end_time:
                cycle += 1
                print(f"\nüîÑ Live Monitoring Cycle {cycle}")
                print("-" * 30)

                # Run monitoring cycle
                stats = manager.run_monitoring_cycle()

                if stats['messages_found'] > 0:
                    print(f"üìä Found {stats['messages_found']} new messages")
                else:
                    print("üì≠ No new messages this cycle")

                # Wait before next cycle
                if datetime.now() < end_time:
                    wait_time = min(Config.MESSAGE_CHECK_INTERVAL, 30)  # Cap at 30s for demo
                    print(f"‚è∏Ô∏è Waiting {wait_time}s before next cycle...")
                    time.sleep(wait_time)

            print("\nüèÅ Live monitoring demo completed!")
            return True

        except KeyboardInterrupt:
            print("\n‚èπÔ∏è Live demo stopped by user")
            return True
        except Exception as e:
            print(f"‚ùå Error in live demo: {e}")
            return False

    def create_live_deployment_guide(self):
        """Create a guide for full live deployment"""
        print("\nüìã LIVE DEPLOYMENT GUIDE")
        print("=" * 50)

        print("\nüéØ For Full Live Deployment:")
        print("1. ‚úÖ Accounts Validated - Your accounts are ready")
        print("2. üîß Update Configuration:")
        print("   ‚Ä¢ Set AUTO_REPLY_ENABLED=True in config")
        print("   ‚Ä¢ Adjust MESSAGE_CHECK_INTERVAL as needed")
        print("   ‚Ä¢ Configure REPLY_DELAY_MIN/MAX for your use case")

        print("\n3. üöÄ Launch Live System:")
        print("   ‚Ä¢ Run: python phase4_message_monitoring.py")
        print("   ‚Ä¢ Choose longer monitoring duration (60+ minutes)")
        print("   ‚Ä¢ Monitor performance and adjust as needed")

        print("\n4. üìä Monitor and Optimize:")
        print("   ‚Ä¢ Check logs/bot.log for detailed activity")
        print("   ‚Ä¢ Monitor AI response quality and customer satisfaction")
        print("   ‚Ä¢ Adjust AI prompts if needed")
        print("   ‚Ä¢ Scale to additional accounts as needed")

        print("\n‚ö†Ô∏è  IMPORTANT CONSIDERATIONS:")
        print("   ‚Ä¢ Start with short monitoring sessions (30-60 minutes)")
        print("   ‚Ä¢ Monitor Facebook account health")
        print("   ‚Ä¢ Be responsive to customer escalations")
        print("   ‚Ä¢ Comply with Facebook's Terms of Service")
        print("   ‚Ä¢ Keep human oversight for complex situations")


def main():
    """Main execution function"""
    print("üîê Facebook Marketplace Bot - Live Integration Setup")
    print("=" * 60)
    print("This will help you connect to real Facebook accounts for live monitoring.")
    print()

    integrator = LiveFacebookIntegration()

    print("üéØ SETUP PROCESS:")
    print("1. Create secure test account")
    print("2. Validate Facebook login")
    print("3. Test live monitoring")
    print("4. Deploy full system")
    print()

    # Step 1: Create test account
    test_account = integrator.create_secure_test_account()
    if not test_account:
        print("‚ùå Account setup failed. Cannot proceed.")
        return False

    integrator.test_accounts.append(test_account)

    # Step 2: Validate login
    print(f"\nüß™ Validating account {test_account.get_masked_email()}")
    if integrator.test_facebook_login(test_account):
        integrator.validated_accounts.append(test_account)
        print("‚úÖ Account validation successful!")
    else:
        print("‚ùå Account validation failed.")
        print("\nüí° TROUBLESHOOTING TIPS:")
        print("‚Ä¢ Try logging into Facebook manually first")
        print("‚Ä¢ Complete any security verifications")
        print("‚Ä¢ Ensure account is not locked or restricted")
        print("‚Ä¢ Check for CAPTCHA requirements")
        return False

    # Step 3: Setup live monitoring
    if not integrator.setup_live_monitoring_session(integrator.validated_accounts):
        print("‚ùå Live monitoring setup failed.")
        return False

    # Step 4: Demo or deploy
    print(f"\nüé¨ NEXT STEP:")
    choice = input("Run live monitoring demo? [Y/n]: ").strip().lower()

    if choice != 'n':
        try:
            duration = input("Demo duration in minutes [5]: ").strip()
            duration = int(duration) if duration else 5
        except:
            duration = 5

        success = integrator.run_live_monitoring_demo(duration)

        if success:
            integrator.create_live_deployment_guide()
            print("\nüéâ Live integration setup completed successfully!")
            print("Your system is ready for full live deployment!")
            return True
    else:
        integrator.create_live_deployment_guide()
        print("\n‚úÖ Live integration setup completed!")
        return True


if __name__ == "__main__":
    try:
        success = main()
        if success:
            print("\nüöÄ Ready for live Facebook monitoring!")
        else:
            print("\n‚ùå Live integration setup encountered issues.")
    except KeyboardInterrupt:
        print("\n\n‚èπÔ∏è Setup interrupted by user.")
    except Exception as e:
        print(f"\n‚ùå Unexpected error: {e}")